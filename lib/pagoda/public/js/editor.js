// Generated by CoffeeScript 1.4.0
(function() {

  $(document).ready(function() {
    var focus_to_type, handle_events, init, is_edit_page, keyboard_events, save_post, set_save_button, show_shortcuts;
    key.filter = function(e) {
      return true;
    };
    is_edit_page = function() {
      return window.location.pathname.indexOf('edit') !== -1;
    };
    set_save_button = function(status) {
      if (status === 'saving') {
        $('#save-button').val('Saving');
        return $('#save-button').addClass('post-saving');
      } else if (status === 'saved') {
        $('#save-button').val('Saved');
        return setTimeout((function() {
          $('#save-button').val('Save');
          return $('#save-button').removeClass('post-saving');
        }), 1000);
      } else if (status === 'error') {
        $('#save-button').val('Error');
        $('#save-button').removeClass('post-saving');
        return setTimeout((function() {
          return set_save_button('saved');
        }), 2000);
      }
    };
    save_post = function() {
      var draft, post_obj;
      set_save_button('saving');
      draft = $('#post_draft').is(':checked') ? 'on' : 'off';
      post_obj = {
        post: {
          title: $('#post_title').val(),
          content: $('#post_content').val(),
          name: $('#post_name').val(),
          draft: draft
        },
        ajax: true
      };
      return $.post('/save-post', post_obj, function(data) {
        var response;
        response = $.parseJSON(data);
        if (response['status'] === 'OK') {
          return setTimeout((function() {
            return set_save_button('saved');
          }), 1000);
        } else {
          return set_save_button('error');
        }
      }).fail((function() {
        return set_save_button('error');
      }));
    };
    handle_events = function() {
      $('#post-editor #post_title').autosize({
        append: "\n"
      });
      $("#fullscreen").click(function(e) {
        return screenfull.request();
      });
      screenfull.onchange = function() {
        if (screenfull.isFullscreen) {
          $('#fullscreen').hide();
          $('#post_content').focus();
          return setTimeout(function() {
            var rows;
            rows = Math.ceil($(window).height() / 40);
            return $('#post_content').attr('rows', rows);
          }, 1000);
        } else {
          $('#fullscreen').show();
          return $('#post_content').attr('rows', 18);
        }
      };
      $('.delete-button').click(function() {
        if (!confirm("Confirm delete?")) {
          return false;
        }
      });
      if (is_edit_page()) {
        return $('#save-button').click(function() {
          save_post();
          return false;
        });
      }
    };
    keyboard_events = function() {
      key('⌘+enter, ctrl+enter', function(e) {
        return screenfull.toggle();
      });
      return key('⌘+s, ctrl+s', function(e) {
        if (!is_edit_page()) {
          $('.edit_post').submit();
        } else {
          save_post();
        }
        return false;
      });
    };
    show_shortcuts = function() {
      var fulls_shortcut, is_mac, save_shortcut, special_key;
      is_mac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      special_key = is_mac ? '⌘' : 'ctrl';
      save_shortcut = special_key + '+S';
      fulls_shortcut = special_key + '+Enter';
      $('#save-button').attr('title', save_shortcut);
      $('#fullscreen').attr('title', fulls_shortcut);
      $("#save-button").tipTip({
        delay: 200
      });
      return $("#fullscreen").tipTip({
        delay: 200,
        defaultPosition: 'right'
      });
    };
    focus_to_type = function() {
      if (!is_edit_page() && ($('#post_title').val() === '')) {
        return $('#post_title').focus();
      } else {
        return $('#post_content').focus();
      }
    };
    init = function() {
      handle_events();
      keyboard_events();
      show_shortcuts();
      return focus_to_type();
    };
    return init();
  });

}).call(this);
